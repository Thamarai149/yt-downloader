/**
 * Code Signing Setup Helper
 * Helps configure code signing for the application
 * 
 * Requirements: 1.1
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const ROOT_DIR = path.join(__dirname, '..');
const ENV_SIGNING_FILE = path.join(ROOT_DIR, '.env.signing');
const ENV_EXAMPLE_FILE = path.join(ROOT_DIR, '.env.signing.example');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function question(query) {
  return new Promise(resolve => rl.question(query, resolve));
}

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë   Code Signing Setup                   ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

async function main() {
  console.log('This script will help you configure code signing for your application.\n');
  
  // Check if .env.signing already exists
  if (fs.existsSync(ENV_SIGNING_FILE)) {
    console.log('‚ö†Ô∏è  .env.signing already exists.');
    const overwrite = await question('Do you want to overwrite it? (y/N): ');
    if (overwrite.toLowerCase() !== 'y') {
      console.log('Aborted.');
      rl.close();
      return;
    }
  }
  
  console.log('\nüìù Please provide the following information:\n');
  
  // Platform selection
  console.log('Which platform(s) do you want to sign for?');
  console.log('1. Windows only');
  console.log('2. macOS only');
  console.log('3. Both Windows and macOS');
  const platformChoice = await question('Enter choice (1-3): ');
  
  let config = '# Code Signing Environment Variables\n';
  config += '# Generated by setup-code-signing.js\n';
  config += '# NEVER commit this file to Git!\n\n';
  
  // Windows configuration
  if (platformChoice === '1' || platformChoice === '3') {
    console.log('\n--- Windows Code Signing ---\n');
    
    const certPath = await question('Path to .pfx certificate file: ');
    const certPassword = await question('Certificate password: ');
    
    config += '# Windows Code Signing\n';
    config += `CSC_LINK=${certPath}\n`;
    config += `CSC_KEY_PASSWORD=${certPassword}\n\n`;
  }
  
  // macOS configuration
  if (platformChoice === '2' || platformChoice === '3') {
    console.log('\n--- macOS Code Signing ---\n');
    
    const certName = await question('Certificate name (e.g., Developer ID Application: Your Name): ');
    const appleId = await question('Apple ID email: ');
    const applePassword = await question('App-specific password: ');
    const teamId = await question('Apple Team ID (optional): ');
    
    config += '# macOS Code Signing\n';
    config += `CSC_NAME=${certName}\n\n`;
    config += '# macOS Notarization\n';
    config += `APPLE_ID=${appleId}\n`;
    config += `APPLE_ID_PASSWORD=${applePassword}\n`;
    if (teamId) {
      config += `APPLE_TEAM_ID=${teamId}\n`;
    }
    config += '\n';
  }
  
  // GitHub token (optional)
  console.log('\n--- GitHub Releases (Optional) ---\n');
  const addGithub = await question('Add GitHub token for releases? (y/N): ');
  if (addGithub.toLowerCase() === 'y') {
    const ghToken = await question('GitHub Personal Access Token: ');
    config += '# GitHub Token for releases\n';
    config += `GH_TOKEN=${ghToken}\n\n`;
  }
  
  // Write configuration
  fs.writeFileSync(ENV_SIGNING_FILE, config);
  
  console.log('\n‚úÖ Configuration saved to .env.signing');
  console.log('\n‚ö†Ô∏è  IMPORTANT:');
  console.log('   - Keep this file secure');
  console.log('   - Never commit it to Git');
  console.log('   - Use strong passwords');
  console.log('\nüìñ Next steps:');
  console.log('   1. Verify the configuration in .env.signing');
  console.log('   2. Update electron-builder.json if needed');
  console.log('   3. Build with: npm run package:win (or package:mac)');
  console.log('\nüìö For more information, see CODE_SIGNING.md\n');
  
  rl.close();
}

main().catch(error => {
  console.error('\n‚ùå Error:', error.message);
  rl.close();
  process.exit(1);
});
